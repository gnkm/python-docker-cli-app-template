# 設計ドキュメント

## 概要

このドキュメントは、uvとDocker Composeを使用したPython CLIアプリケーション「my-app」の技術設計を定義します。アプリケーションはTyperライブラリを使用してCLIインターフェースを実装し、Dockerコンテナ内で実行されます。設計は参考資料のuv-docker-exampleプロジェクトのベストプラクティスに基づいています。

## アーキテクチャ

### 全体構成

```
.
├── src/
│   └── my_app/
│       ├── __init__.py
│       └── cli.py
├── tests/
│   ├── __init__.py
│   └── test_cli.py
├── .pre-commit-config.yaml
├── pyproject.toml
├── uv.lock
├── Dockerfile
├── compose.yml
├── .dockerignore
└── README.md
```

### コンテナアーキテクチャ

- **ベースイメージ**: `ghcr.io/astral-sh/uv:python3.12-bookworm-slim`
- **作業ディレクトリ**: `/app`
- **仮想環境**: `/app/.venv`
- **エントリーポイント**: `my-app` コマンド（pyproject.tomlで定義）

## コンポーネントとインターフェース

### 1. CLIモジュール (`src/my_app/cli.py`)

**責任**:
- Typerを使用したコマンドライン引数の解析
- helloコマンドの実装
- ヘルプテキストの自動生成

**インターフェース**:
```python
import typer

app = typer.Typer()

@app.command()
def hello(name: str) -> None:
    """指定された名前で挨拶を表示する"""

@app.callback()
def main() -> None:
    """my-app CLI アプリケーション"""

if __name__ == "__main__":
    app()
```

### 2. メインモジュール (`src/my_app/__init__.py`)

**責任**:
- パッケージの初期化
- CLIアプリケーションのエクスポート

**インターフェース**:
```python
from .cli import app as cli_app

__version__ = "0.1.0"
__all__ = ["cli_app"]
```

### 3. プロジェクト設定 (`pyproject.toml`)

**責任**:
- プロジェクトメタデータの定義
- 依存関係の管理
- CLIエントリーポイントの定義

**主要設定**:
```toml
[project]
name = "my-app"
version = "0.1.0"
dependencies = ["typer>=0.9.0"]

[project.scripts]
my-app = "my_app.cli:app"
```

### 4. Docker設定

#### Dockerfile
**責任**:
- uvを使用した効率的なイメージビルド
- 依存関係とプロジェクトの分離インストール
- 最適化されたレイヤーキャッシュ

**主要機能**:
- マルチステージビルドによる最適化
- uvキャッシュマウントの活用
- バイトコードコンパイルの有効化

#### compose.yml
**責任**:
- 開発環境での簡単な実行
- ボリュームマウントによる開発効率化

## データモデル

### コマンド引数

```python
class HelloCommand:
    name: str  # 必須パラメータ、挨拶対象の名前
```

### 出力形式

```python
class GreetingOutput:
    message: str  # "hello {name}" 形式の挨拶メッセージ
```

## エラーハンドリング

### 1. 引数エラー
- **発生条件**: 必須引数が提供されない場合
- **処理**: Typerが自動的にエラーメッセージとヘルプを表示
- **終了コード**: 2

### 2. 実行時エラー
- **発生条件**: 予期しない実行時エラー
- **処理**: エラーメッセージを標準エラー出力に表示
- **終了コード**: 1

### 3. 正常終了
- **発生条件**: コマンドが正常に実行完了
- **処理**: 結果を標準出力に表示
- **終了コード**: 0

## テスト戦略

### 1. 単体テスト
- **対象**: CLI関数の個別テスト
- **ツール**: pytest
- **カバレッジ**: コマンド実行ロジック、引数解析

### 2. 統合テスト
- **対象**: CLIアプリケーション全体のテスト
- **ツール**: pytest + typer.testing.CliRunner
- **カバレッジ**: コマンドライン引数から出力までの完全なフロー

### 3. Dockerテスト
- **対象**: コンテナ内でのアプリケーション実行
- **方法**: docker compose runコマンドでの実行テスト
- **カバレッジ**: 実際の使用シナリオの検証

## Docker最適化戦略

### 1. レイヤーキャッシュ最適化
- 依存関係のインストールとプロジェクトコードのコピーを分離
- uv.lockとpyproject.tomlを先にコピーして依存関係をインストール
- プロジェクトコードの変更時に依存関係の再インストールを回避

### 2. ビルド最適化
- `UV_COMPILE_BYTECODE=1` でバイトコードコンパイルを有効化
- `UV_LINK_MODE=copy` でキャッシュマウント使用時の警告を回避
- `--no-install-project` フラグで段階的インストール

### 3. 実行時最適化
- 仮想環境のbinディレクトリをPATHに追加
- 不要なuvバイナリを最終イメージから除外（マルチステージビルド使用時）

## セキュリティ考慮事項

### 1. イメージセキュリティ
- 公式のuvイメージを使用してセキュリティアップデートを確保
- 最小限の依存関係でアタックサーフェスを削減

### 2. 実行時セキュリティ
- 非rootユーザーでの実行（必要に応じて）
- 読み取り専用ファイルシステムの使用（必要に応じて）

## パフォーマンス要件

### 1. ビルド時間
- 初回ビルド: 2分以内
- 依存関係変更なしの再ビルド: 30秒以内

### 2. 実行時間
- helloコマンドの実行: 1秒以内
- ヘルプ表示: 1秒以内

### 3. イメージサイズ
- 最終イメージサイズ: 200MB以下（マルチステージビルド使用時）
